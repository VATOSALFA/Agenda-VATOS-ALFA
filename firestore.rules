rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ---------------------------------------------------------
    // HELPERS
    // ---------------------------------------------------------
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ---------------------------------------------------------
    // RULES
    // ---------------------------------------------------------

    // 1. Business Configuration (Public Read for Login/Branding)
    match /empresa/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated(); 
    }
    match /configuracion/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    match /locales/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // 2. User Profiles
    match /usuarios/{userId} {
      allow read, update: if isOwner(userId);
      allow create: if isAuthenticated(); 
      // Allow general read/write for Staff access logic (since we lack custom claims for now)
      allow read, write: if isAuthenticated();
    }

    // 3. Professionals (Staff)
    match /profesionales/{profId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); 
    }

    // 4. Roles & Permissions
    match /roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // 5. Services & Products (Catalog)
    match /servicios/{document=**} { allow read, write: if isAuthenticated(); }
    match /categorias_servicios/{document=**} { allow read, write: if isAuthenticated(); }
    match /products/{document=**} { allow read, write: if isAuthenticated(); }
    match /brands/{document=**} { allow read, write: if isAuthenticated(); }
    match /presentations/{document=**} { allow read, write: if isAuthenticated(); }
    match /categories/{document=**} { allow read, write: if isAuthenticated(); }

    // 6. Business Logic (Sales, Clients, Finance)
    match /reservas/{document=**} { allow read, write: if isAuthenticated(); }
    match /bloqueos_horario/{document=**} { allow read, write: if isAuthenticated(); }
    
    match /sales/{document=**} { allow read, write: if isAuthenticated(); }
    
    match /clientes/{document=**} { allow read, write: if isAuthenticated(); } 
    match /clients/{document=**} { allow read, write: if isAuthenticated(); } 

    match /finanzas/{document=**} { allow read, write: if isAuthenticated(); }

    // 7. Communications
    match /conversations/{document=**} { allow read, write: if isAuthenticated(); }

    // DENY ALL OTHERS BY DEFAULT
    // No catch-all rule here.
  }
}
