rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ---------------------------------------------------------
    // HELPERS
    // ---------------------------------------------------------
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ---------------------------------------------------------
    // RULES
    // ---------------------------------------------------------

    // 1. Business Configuration (Public Read for Login/Branding)
    match /empresa/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated(); 
    }
    match /settings/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    match /configuracion/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    match /locales/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    match /ajustes_sitio/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    match /promociones/{document=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // 2. User Profiles
    match /usuarios/{userId} {
      allow read, update: if isOwner(userId);
      allow create: if isAuthenticated(); 
      // Allow general read/write for Staff access logic (since we lack custom claims for now)
      allow read, write: if isAuthenticated();
    }

    // 3. Professionals (Staff) - MODIFICADO PARA ACCESO PÚBLICO
    match /profesionales/{profId} {
      allow read: if true;  // <--- ¡Esto es la clave! Cualquiera puede ver la lista
      allow write: if isAuthenticated(); // Solo el dueño puede editar/borrar
    }

    // 4. Roles & Permissions
    match /roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // 5. Services & Products (Catalog)
    match /servicios/{document=**} { 
      allow read: if true; 
      allow write: if isAuthenticated(); 
    }
    
    // Lo demás de productos lo dejamos protegido
    match /categorias_servicios/{document=**} { 
      allow read: if true; 
      allow write: if isAuthenticated(); 
    }
    match /products/{document=**} { 
      allow read: if true;
      allow write: if isAuthenticated(); 
    }
    match /productos/{document=**} { 
      allow read: if true;
      allow write: if isAuthenticated(); 
    } 
    match /brands/{document=**} { allow read, write: if isAuthenticated(); }
    match /presentations/{document=**} { allow read, write: if isAuthenticated(); }
    match /categories/{document=**} { allow read, write: if isAuthenticated(); }

    // 6. Business Logic (Sales, Clients, Finance)
    match /reservas/{document=**} { allow read, write: if isAuthenticated(); }
    match /bloqueos_horario/{document=**} { allow read, write: if isAuthenticated(); }
    
    match /sales/{document=**} { allow read, write: if isAuthenticated(); }
    match /ventas/{document=**} { allow read, write: if isAuthenticated(); } // Added for Spanish collection name
    match /caja/{document=**} { allow read, write: if isAuthenticated(); }   // Added for cash register
    
    match /clientes/{document=**} { allow read, write: if isAuthenticated(); } 
    match /clients/{document=**} { allow read, write: if isAuthenticated(); } 

    match /finanzas/{document=**} { allow read, write: if isAuthenticated(); }
    match /finanzas_mensuales/{document=**} { allow read, write: if isAuthenticated(); }

    // 7. Communications
    match /conversations/{document=**} { allow read, write: if isAuthenticated(); }
    match /whatsapp_configuraciones/{document=**} { allow read, write: if isAuthenticated(); }

    // 8. Other Business Data (Spanish naming conventions found in code)
    match /terminales/{document=**} { allow read, write: if isAuthenticated(); }
    match /codigos_autorizacion/{document=**} { allow read, write: if isAuthenticated(); }
    match /egresos/{document=**} { allow read, write: if isAuthenticated(); }
    match /ingresos_manuales/{document=**} { allow read, write: if isAuthenticated(); }
    match /cortes_caja/{document=**} { allow read, write: if isAuthenticated(); }
    
    // Product Catalog (Spanish)
    match /categorias_productos/{document=**} { allow read, write: if isAuthenticated(); }
    match /formatos_productos/{document=**} { allow read, write: if isAuthenticated(); }
    match /marcas_productos/{document=**} { allow read, write: if isAuthenticated(); }
    match /movimientos_inventario/{document=**} { allow read, write: if isAuthenticated(); }
    
    // Payments (Generic catch-all if needed, though usually covered by sales/caja)
    match /pagos/{document=**} { allow read, write: if isAuthenticated(); }
    match /audit_logs/{document=**} { allow read, write: if isAuthenticated(); }

    // DENY ALL OTHERS BY DEFAULT
    // No catch-all rule here.
  }
}
