
run:
  build:
    - npm ci
    - npm run build
  start:
    - next start

backend:
  id: functions
  env:
    # --- FIREBASE & TWILIO (Estándar) ---
    - variable: FIREBASE_SERVICE_ACCOUNT_KEY
      secret: FIREBASE_SERVICE_ACCOUNT_KEY
    - variable: TWILIO_ACCOUNT_SID
      secret: TWILIO_ACCOUNT_SID
    - variable: TWILIO_AUTH_TOKEN
      secret: TWILIO_AUTH_TOKEN
    
    # --- EMAILS ---
    - variable: RESEND_API_KEY
      secret: RESEND_API_KEY

    # --- MERCADO PAGO: WEB (Pagos en Línea) ---
    - variable: MP_WEB_ACCESS_TOKEN
      secret: MP_WEB_ACCESS_TOKEN
      
    - variable: MP_WEB_WEBHOOK_SECRET
      secret: MP_WEB_WEBHOOK_SECRET

    # --- MERCADO PAGO: TERMINAL (Física) ---
    # ¡Simetría total!
    - variable: MP_TERMINAL_ACCESS_TOKEN
      secret: MP_TERMINAL_ACCESS_TOKEN
    - variable: MP_TERMINAL_WEBHOOK_SECRET
      secret: MP_TERMINAL_WEBHOOK_SECRET

    # --- RECAPTCHA ---
    - variable: RECAPTCHA_SECRET_KEY
      secret: RECAPTCHA_SECRET_KEY
      
  secretManagement:
    grantAccess: true

runConfig:
  minInstances: 0
  maxInstances: 2
  cpu: 1
  memoryMiB: 512

headers:
  - source: /api/mercado-pago-webhook
    function: functions

env:
  # --- APP URL (CRÍTICO) ---
  - variable: NEXT_PUBLIC_APP_URL
    value: https://vatosalfa.com

  # --- FIREBASE CLIENT CONFIG ---
  - variable: NEXT_PUBLIC_FIREBASE_API_KEY
    secret: NEXT_PUBLIC_FIREBASE_API_KEY
  - variable: NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
    secret: NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
  - variable: NEXT_PUBLIC_FIREBASE_PROJECT_ID
    secret: NEXT_PUBLIC_FIREBASE_PROJECT_ID
  - variable: NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID
    secret: NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID
  - variable: NEXT_PUBLIC_FIREBASE_APP_ID
    secret: NEXT_PUBLIC_FIREBASE_APP_ID
  - variable: NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID
    secret: NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID
  - variable: NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
    secret: NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
  
  # --- MERCADO PAGO CLIENT ---
  # También actualizamos este secreto para que el nombre sea específico
  - variable: NEXT_PUBLIC_MP_WEB_PUBLIC_KEY
    secret: NEXT_PUBLIC_MP_WEB_PUBLIC_KEY

  # --- GEMINI ---
  - variable: GEMINI_API_KEY
    secret: GEMINI_API_KEY
  
  # --- TWILIO ---
  - variable: NEXT_PUBLIC_TWILIO_PHONE_NUMBER
    secret: NEXT_PUBLIC_TWILIO_PHONE_NUMBER
  
  # --- RECAPTCHA (Valor fijo) ---
  - variable: NEXT_PUBLIC_RECAPTCHA_SITE_KEY
    value: 6Lce0DosAAAAANOwXUjYDZIp8JTRaqnyJ9HqZ9Oo